#!/bin/bash
#   -----------------------------------------------------------------------------------------
#   Copyright (c) 2018 rit
#   -----------------------------------------------------------------------------------------
#   Creative Commons Attribution-NonCommercial-NoDerivs 3.0 Unported License.
#   -----------------------------------------------------------------------------------------

#Config
BASEDIR=$(readlink -f "$0")
BASEDIR=$(dirname "$BASEDIR")

source ${BASEDIR}/backup-loadconfig
source ${BASEDIR}/backup-loadfunc

fstart $0

IN_DIR=${Download[IN_DIR]}
USER=${Download[USER]}
GROUP=${Download[GROUP]}
NUM=${Download[NUM]}
LOCAL_BACKUPS_NUM=${Download[LOCAL_BACKUPS_NUM]}

if [ ! -d "$IN_DIR" ]; then; mkdir -p ${IN_DIR}; fi

for i in $(eval echo "{1..$NUM}")
do
	eval varAlias=(\${"Server"$i[@]})
	EX_DIR="${varAlias[0]}"

	if [ ! -d "$EX_DIR" ]; then ; mkdir -p ${EX_DIR}; fi

	PW="${varAlias[1]}"
	PW=`echo ${PW} | base64 --decode`
	PORT=${varAlias[2]}
	IP=${varAlias[3]}
	NAME=${varAlias[4]}
	R_USER=${varAlias[5]}

	#echo "$varAlias"
	#echo "$EX_DIR | $PW | $IP | $PORT | $NAME | $R_USER"
	#exit 0

	fstatus "${NAME} --> download started"

	sshpass -p $PW rsync --stats --chown=$USER:$GROUP -trzhPogpq -e "ssh -p ${PORT}" ${R_USER}@${IP}:${EX_DIR}/ ${IN_DIR}/${NAME} > /dev/null 2>&1
	#--progress --stats
	TEST=$?
	ftest $TEST "${NAME} --> donwload finished" "${NAME} --> download failed"

	if [ $TEST -ne 0 ]
	then
		sleep 10
		fstatus "${NAME} --> trying to restart"
		sshpass -p $PW rsync --stats --chown=$USER:$GROUP -trzhPogpq -e "ssh -p ${PORT}" ${R_USER}@${IP}:${EX_DIR}/ ${IN_DIR}/${NAME} > /dev/null 2>&1
		ftest $? "${NAME} --> donwload finished" "${NAME} --> download failed"
	fi	

	${BASEDIR}/backup-remove ${IN_DIR}/${NAME} $LOCAL_BACKUPS_NUM
done

fdone $0

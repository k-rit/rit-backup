#!/bin/bash

DATE_H=$(date +%d.%m.%Y-%H:%M:%S)
echo "[${DATE_H}] - Starte $0"
#Config
BASEDIR=$(dirname "$0")
CONFIG="${BASEDIR}/backup.conf"

if [ ! -f "${CONFIG}" ]
then
	echo "Config-Datei nicht gefunden!"
	exit
fi

USER=$(awk '/^\[Sinusbot\]/{f=1} f==1&&/^USER/{print $3;exit}' "${CONFIG}")
DIR_ROOT=$(awk '/^\[Sinusbot\]/{f=1} f==1&&/^DIR_ROOT/{print $3;exit}' "${CONFIG}")
DIR_BACKUP=$(awk '/^\[Sinusbot\]/{f=1} f==1&&/^DIR_BACKUP/{print $3;exit}' "${CONFIG}")
LOCAL_BACKUPS_NUM=$(awk '/^\[Sinusbot\]/{f=1} f==1&&/^LOCAL_BACKUPS_NUM/{print $3;exit}' "${CONFIG}")

#systemctl stop sinusbot.service
${BASEDIR}/backup-prog sinusbot stop

DATE=$(date +%Y-%m-%d-%H%M%S)

# Temp start
TODAY=`date +%u`
TIMESTAMP="$DIR_ROOT/$0-timestamp.dat"
# Temp end

if [ `whoami` = root ]
then
	su - $USER -c "cd $DIR_ROOT ; tar -cjpf $DIR_BACKUP/sinusbot-$DATE.tar.bz2 -g ${TIMESTAMP} --exclude=$DIR_BACKUP $DIR_ROOT"
else
	cd $DIR_ROOT
	tar -cjpf $DIR_BACKUP/sinusbot-$DATE.tar.bz2 -g ${TIMESTAMP} --exclude=$DIR_BACKUP $DIR_ROOT
fi

#systemctl start sinusbot.service
${BASEDIR}/backup-prog sinusbot start

${BASEDIR}/backup-remove $DIR_BACKUP $LOCAL_BACKUPS_NUM

